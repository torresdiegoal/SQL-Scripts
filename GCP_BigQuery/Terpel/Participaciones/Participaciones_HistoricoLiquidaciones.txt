
CREATE OR REPLACE TABLE SAP_resultados_VP_Comercial_Combustibles.Participaciones_Liquidaciones As
SELECT 
  CAST( Codigo_Unico As STRING ) As oCodigoUnico,
  CAST( Estacion As STRING ) As Estacion,
  CAST( Regional As STRING ) As Regional,
  DATE(EXTRACT(YEAR FROM mes_liquidacion),
       EXTRACT(DAY FROM mes_liquidacion),
       EXTRACT(MONTH FROM mes_liquidacion)) As oCalendarioKey,
  CASE WHEN UPPER(Segmento_liquidacion) LIKE '%FRANQ%' THEN 'FRANQUICIADAS'
    WHEN REGEXP_CONTAINS(UPPER(Segmento_liquidacion),'(OPESE|MASSER)')  THEN 'MASSER'
    ELSE NULL  END As  Segmento_condicion,
  CAST( Fecha_entrega As DATE ) As FechaCambioSegmento,
  --
  CAST( Centro_logistico As STRING ) As Centro_logistico,
  CAST( Centro_beneficio As STRING ) As Centro_beneficio,
  CAST( Codigo_Solicitante As STRING ) As Codigo_Solicitante,
  CAST( Codigo_destinatario As STRING ) As Codigo_destinatario,
  CAST( 0 As NUMERIC ) As Total_PptoVolumen_MesVenc,
  CAST( Volumen_Ppto_MesAct As NUMERIC ) As Total_PptoVolumen_MesAct,
  CAST( Volumen_Compra_MesAct As NUMERIC ) As Total_Volumen_Compra_MesAct,
  CAST( Volumen_Venta_MesVenc As NUMERIC ) As Total_VolumenDeVenta_MesVenc,
  CAST( Volumen_Venta_MesAct As NUMERIC ) As Total_VolumenDeVenta_MesAct,
  CAST( Margen As NUMERIC ) As Total_Margen,
  CAST( 0 As NUMERIC ) As Total_PptoMargen,
  CAST( Utilidad_Bruta As NUMERIC ) As Total_Utilidad_Bruta,
  CAST( Gastos As NUMERIC ) As Total_Gastos,
  CAST( 0 As NUMERIC ) As Total_PptoGastos,
  CAST( 0 As INT64 ) As Pesos_gal_VentaCombustible,
  CAST( Participacion_VentaCombustibles As NUMERIC ) As Participacion_VentaCombustibles,
  CAST( Pesos_gln_No_Decrecimiento_Ventas As NUMERIC ) As Pesos_NoDecrecVentas,
  CAST( Participacion_No_Decrecimiento_Ventas As NUMERIC ) As Participacion_No_Decrecimiento_Venta,
  --CAST( retiros_ As INT64 ) As Numero_Isleros,
  CAST( N_Retiros As INT64 ) As Numero_Isleros, 
  CAST( N_Empleados As INT64 ) As Numero_Retiros,
  CAST( 0 As NUMERIC ) As Pesos_Galon_Participacion_Rotacion,
  CAST( Participacion_Rotacion_Personal As NUMERIC ) As Participacion_Rotacion_Personal,
  CAST( 0 As NUMERIC ) As Total_Calificacion_CO_I_MesVenc,
  CAST( Imagen_Trimestral As NUMERIC ) As Total_Imagen_MesVenc,
  CAST( Servicio_CO As NUMERIC ) As Total_Calificacion_CO_I_final,
  CAST( Participacion_ClienteOculto As NUMERIC ) As Participacion_ClienteOculto,
  CAST( Fidelizacionporc As NUMERIC ) As Fidelizacion,
  CAST( 0 As INT64 ) As Total_ClientesReferidos_MesAct,
  CAST( N_ClientesReferidos As INT64 ) As Total_ClientesReferidos_MesVenc,
  CAST( 0 As NUMERIC ) As Total_TransacFidelizadas_MesAct,
  CAST( Transacciones_Fidelizadas As NUMERIC ) As Total_TransacFidelizadas_MesVenc,
  CAST( 0 As INT64 ) As Participacion_ViveTerpel,
  CAST( 0 As NUMERIC ) As perc_Volumen_NoConvencional,
  CAST( 0 As NUMERIC ) As Pesos_Participacion_MillaRedimida,
  CAST( 0 As NUMERIC ) As Participacion_MetodosNoConvencionales,
  CAST( Participacion_ViveTerpel As NUMERIC ) As Participacion_MetodosNoConv_ViveTerpel,
  CAST( EDS_Confiable As NUMERIC ) As Total_Confiable_MesVenc,
  CAST( Participaci__n_EDS_confiable As NUMERIC ) As Participacion_Confiable,
  CAST( Cumplimiento_Ppto As NUMERIC ) As Cumplimiento_Ppto,
  CAST( Participacion_CumplimientoVentas As NUMERIC ) As Participacion_CumplimientoVentas,
  CAST( Participacion_adicional_Ajustes As NUMERIC ) As Participacion_Adicional,
  --CAST( Participacion_total_del_franquiciado As NUMERIC ) As Participacion_Aliado,
  --CAST( REPLACE(Participacion_total_franquiciado,'#Â¡VALOR!','0') As NUMERIC ) As Participacion_Aliado, 
  CAST( Participacion_total_franquiciado As NUMERIC ) As Participacion_Aliado, 
  CAST( 0 As NUMERIC ) As Ganancia_Aliado,
  CAST( Participacion_inicial_Terpel As NUMERIC ) As Participacion_TERPEL_Inicial,
  CAST( 0 As NUMERIC ) As Faltante_en_Gasto,
  CAST( Incentivo_Competitivo As NUMERIC ) As Incentivo_Competitivo,
  CAST( Perdida_70porc As NUMERIC ) As PerdidaTotal_70,
  CAST( 0 As NUMERIC ) As Perdida_Asumida_Terpel,
  CAST( 0 As NUMERIC ) As Particip_Terpel_Inicial_Total,
  CAST( Participacion_TERPEL_Final As NUMERIC ) As Participacion_TERPEL_Final,
  CAST( Regalia As FLOAT64 ) As Regalia,
  CAST( 0 As FLOAT64 ) As Ppto_Regalia,
  CAST( 0 As NUMERIC ) As Participacion_Rumbo_Regalia,
  CAST( Factura_regalia_canal_13_rumbo As FLOAT64 ) As Regalia_Rumbo,
  CAST( Factura_regalia_canal_12_propias As FLOAT64 ) As Regalia_EDS_Propias,
  CAST( 0 As FLOAT64 ) As IVA_19_pesos,
  CAST( 0 As FLOAT64 ) As Factura_Regalia,
  CAST( Volumen_rumbo As NUMERIC ) As Total_Volumen_rumbo,
  CAST( 0 As NUMERIC ) As Participacion_Rumbo,
  CAST( Volumen_Clientes_Descuento As FLOAT64 ) As Volumen_Coltanques,
  CAST( Factura_Participacion_Terpel_canal_13_rumbo As FLOAT64 ) As Rumbo_pesos,
  CAST( Factura_Participacion_Terpel_canal_12_propias As FLOAT64 ) As EDS_Propias_pesos,
FROM `terpel-gtic-datalake.SAP_archivos_maestros.Participaciones_HistoricoLiquidaciones_16_21` 
ORDER BY oCalendarioKey, oCodigoUnico, Segmento_condicion